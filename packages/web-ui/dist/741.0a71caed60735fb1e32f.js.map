{"version":3,"sources":["./src/app/@core/algo.worker.ts"],"names":["ctx","self","running","timer","userOnTick","userStop","post","msg","postMessage","safeClearTimer","clearTimeout","onmessage","ev","data","type","systemId","source","config","meta","api","log","args","metric","pnl","placeOrder","order","exports","Function","fn","onTick","userStart","start","stop","e","error","String","message","t","loop","setTimeout"],"mappings":"mBAcA,MAAMA,EAAWC,KACjB,IAAIC,GAAU,EACVC,EAAa,KACbC,EAA2C,KAC3CC,EAAgC,KAEpC,SAASC,EAAKC,GAEZP,EAAIQ,YAAYD,GAGlB,SAASE,IACHN,IACFO,aAAaP,GACbA,EAAQ,MAIZH,EAAIW,UAAaC,I,QACf,MAAML,EAAMK,EAAGC,KACf,GAAKN,GAAsB,iBAARA,EAEnB,GAAiB,QAAbA,EAAIO,MAAmBZ,GA0DpB,GAAiB,SAAbK,EAAIO,KAAiB,CAC9BZ,GAAU,EACVO,IACA,IAAMJ,GAAYA,IAAc,UAChCC,EAAK,CAAEQ,KAAM,UAAWC,SAAUR,EAAIQ,gBA9DJ,CAClCb,GAAU,EACV,MAAM,SAAEa,EAAF,OAAYC,EAAZ,OAAoBC,EAApB,KAA4BC,GAASX,EAC3C,IACE,MAAMY,EAAM,CACVC,IAAK,IAAIC,IACPf,EAAK,CAAEQ,KAAM,MAAOC,WAAUM,SAChCC,OAASC,GACPjB,EAAK,CAAEQ,KAAM,SAAUC,WAAUQ,QACnCC,WAAaC,GACXnB,EAAK,CAAEQ,KAAM,QAASC,WAAUU,WAqB9BC,EAhBK,IAAIC,SACb,MACA,SACA,OACA,0HAGIX,GAAU,yTASAY,CAAGT,EAAKF,GAAU,GAAIC,GAAQ,KAAO,GACrDd,EAAuC,mBAAnBsB,EAAQG,OAAwBH,EAAQG,OAAS,KACrE,MAAMC,EAAqC,mBAAlBJ,EAAQK,MAAuBL,EAAQK,MAAQ,KACxE1B,EAAmC,mBAAjBqB,EAAQM,KAAsBN,EAAQM,KAAO,KAE/D,IAAMF,GAAaA,EAAUX,EAAKF,EAAQC,GAAS,MAAOe,GACxD3B,EAAK,CAAEQ,KAAM,QAASC,WAAUmB,MAAOC,QAAiB,QAAV,EAACF,SAAS,eAAEG,UAAWH,KAGvE,IAAII,EAAI,EACR,MAAMC,EAAO,K,MACX,GAAKpC,EAAL,CACAmC,IACA,IACEjC,GAAcA,EAAW,CAAEiC,IAAGpB,SAAQC,SACtC,MAAOe,GACP3B,EAAK,CAAEQ,KAAM,QAASC,WAAUmB,MAAOC,QAAiB,QAAV,EAACF,SAAS,eAAEG,UAAWH,KAEvE9B,EAAQoC,WAAWD,EAAM,OAE3BA,IAEA,MAAOL,GACP3B,EAAK,CAAEQ,KAAM,QAASC,SAAWR,EAAeQ,SAAUmB,MAAOC,QAAiB,QAAV,EAACF,SAAS,eAAEG,UAAWH,KAC/F/B,GAAU,EACVO,Q","file":"741.0a71caed60735fb1e32f.js","sourcesContent":["/* src/app/@core/algo.worker.ts */\r\n\r\n// We intentionally avoid depending on \"lib.webworker\" to prevent DOM conflicts.\r\ntype AnyObj = Record<string, any>;\r\ntype RunMsg = {\r\n  type: 'run';\r\n  systemId: string;\r\n  source: string;\r\n  config: AnyObj;\r\n  meta: AnyObj;\r\n};\r\ntype StopMsg = { type: 'stop'; systemId: string };\r\ntype LogEvent = { systemId: string; args: any[] };\r\n\r\nconst ctx: any = self as any; // treat as DedicatedWorkerGlobalScope\r\nlet running = false;\r\nlet timer: any = null;\r\nlet userOnTick: ((x: AnyObj) => void) | null = null;\r\nlet userStop: (() => void) | null = null;\r\n\r\nfunction post(msg: any) {\r\n  // In worker context, postMessage(message) is fine; typing via ctx avoids DOM overload.\r\n  ctx.postMessage(msg);\r\n}\r\n\r\nfunction safeClearTimer() {\r\n  if (timer) {\r\n    clearTimeout(timer);\r\n    timer = null;\r\n  }\r\n}\r\n\r\nctx.onmessage = (ev: MessageEvent) => {\r\n  const msg = ev.data as RunMsg | StopMsg;\r\n  if (!msg || typeof msg !== 'object') return;\r\n\r\n  if (msg.type === 'run' && !running) {\r\n    running = true;\r\n    const { systemId, source, config, meta } = msg as RunMsg;\r\n    try {\r\n      const api = {\r\n        log: (...args: any[]) =>\r\n          post({ type: 'log', systemId, args } as LogEvent),\r\n        metric: (pnl: number) =>\r\n          post({ type: 'metric', systemId, pnl }),\r\n        placeOrder: (order: AnyObj) =>\r\n          post({ type: 'order', systemId, order }),\r\n      };\r\n\r\n      // Evaluate user strategy in a local scope; capture exports from globals.\r\n      // eslint-disable-next-line no-new-func\r\n      const fn = new Function(\r\n        'api',\r\n        'config',\r\n        'meta',\r\n        `\r\n          \"use strict\";\r\n          // User code can define: start(api, config, meta), onTick(ctx), stop()\r\n          ${source || ''};\r\n          // expose any globals the user defined:\r\n          return {\r\n            start: (typeof start === 'function') ? start : undefined,\r\n            onTick: (typeof onTick === 'function') ? onTick : undefined,\r\n            stop: (typeof stop === 'function') ? stop : undefined\r\n          };\r\n        `\r\n      );\r\n      const exports = fn(api, config || {}, meta || {}) || {};\r\n      userOnTick = typeof exports.onTick === 'function' ? exports.onTick : null;\r\n      const userStart = typeof exports.start === 'function' ? exports.start : null;\r\n      userStop = typeof exports.stop === 'function' ? exports.stop : null;\r\n\r\n      try { userStart && userStart(api, config, meta); } catch (e) {\r\n        post({ type: 'error', systemId, error: String((e as any)?.message || e) });\r\n      }\r\n\r\n      let t = 0;\r\n      const loop = () => {\r\n        if (!running) return;\r\n        t++;\r\n        try {\r\n          userOnTick && userOnTick({ t, config, meta });\r\n        } catch (e) {\r\n          post({ type: 'error', systemId, error: String((e as any)?.message || e) });\r\n        }\r\n        timer = setTimeout(loop, 1000);\r\n      };\r\n      loop();\r\n\r\n    } catch (e) {\r\n      post({ type: 'error', systemId: (msg as RunMsg).systemId, error: String((e as any)?.message || e) });\r\n      running = false;\r\n      safeClearTimer();\r\n    }\r\n  } else if (msg.type === 'stop') {\r\n    running = false;\r\n    safeClearTimer();\r\n    try { userStop && userStop(); } catch {}\r\n    post({ type: 'stopped', systemId: msg.systemId });\r\n  }\r\n};\r\n"],"sourceRoot":"webpack:///"}